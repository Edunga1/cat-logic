<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.3"/><style data-href="/cat-logic/styles.7063392de47b3110fc97.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:0 0;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}*{box-sizing:border-box}body{margin:0}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><style data-styled="" data-styled-version="5.3.11">.cZcHEM{box-sizing:border-box;background-color:#f5f5f5;padding:1rem 1rem 1rem 0;border:1px solid #e0e0e0;}/*!sc*/
.cZcHEM ul{list-style:none;padding-left:1rem;margin:0;font-size:.8rem;}/*!sc*/
.cZcHEM ul p{margin:0;}/*!sc*/
.cZcHEM a{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.cZcHEM a:hover{color:#512DA8;}/*!sc*/
data-styled.g1[id="Toc__Container-sc-1f76i2s-0"]{content:"cZcHEM,"}/*!sc*/
.hKcJdB{overflow:auto;overflow-wrap:break-word;color:#333333;font-size:.8rem;}/*!sc*/
.hKcJdB a{-webkit-text-decoration-style:dotted;text-decoration-style:dotted;}/*!sc*/
.hKcJdB a:visited{color:#B4CFF9;}/*!sc*/
.hKcJdB code:not(pre code){background-color:#f5f5f5;border-radius:.5rem;padding:.2rem .4rem;}/*!sc*/
.hKcJdB pre:has(code){font-size:85%;background-color:#f5f5f5;border-radius:.5rem;padding:1rem;overflow:auto;}/*!sc*/
.hKcJdB img{max-width:100%;}/*!sc*/
.hKcJdB blockquote{border-left:4px solid #ddd;padding-left:1rem;margin-left:0;font-style:italic;}/*!sc*/
.hKcJdB table{width:100%;border-collapse:collapse;}/*!sc*/
.hKcJdB table td,.hKcJdB table th{padding:.2rem .5rem;}/*!sc*/
.hKcJdB table thead{background-color:#F5F5F5;}/*!sc*/
.hKcJdB table tbody{font-size:.8rem;}/*!sc*/
.hKcJdB table tbody tr:nth-child(even){background-color:#F5F5F5;}/*!sc*/
.hKcJdB table tbody tr:hover{background-color:#D0D0D0;}/*!sc*/
data-styled.g2[id="WikiContent__Container-sc-q3jb6a-0"]{content:"hKcJdB,"}/*!sc*/
.bUjFDA{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.bUjFDA:hover{-webkit-text-decoration:underline;text-decoration:underline;}/*!sc*/
data-styled.g3[id="Link__A-sc-k1di17-0"]{content:"bUjFDA,"}/*!sc*/
.gcJKrk{padding-top:20rem;}/*!sc*/
data-styled.g4[id="Comments__Container-sc-1ajj4d9-0"]{content:"gcJKrk,"}/*!sc*/
.kltskx{font-size:1.5rem;text-align:right;}/*!sc*/
.kltskx a{color:#333333;opacity:0.2;font-weight:700;}/*!sc*/
.kltskx a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.kltskx a:after{content:"»";margin-left:.1rem;}/*!sc*/
data-styled.g5[id="HomeLink__Container-sc-1f7ngt2-0"]{content:"kltskx,"}/*!sc*/
.etrcVC{font-size:.7rem;color:#BDBDBD;}/*!sc*/
.etrcVC a{color:#BDBDBD;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g6[id="GitHubCommitLink__Container-sc-13f81rm-0"]{content:"etrcVC,"}/*!sc*/
.fCHAbb{padding-top:10%;color:#333333;overflow:hidden;display:grid;grid-template-columns:1fr;position:relative;}/*!sc*/
.fCHAbb a{color:#0D47A1;}/*!sc*/
@media (min-width:700px){.fCHAbb{padding:1rem 1rem 3rem 1rem;grid-template-columns:.5fr minmax(auto,40rem) 10rem;}.fCHAbb > :nth-child(1){grid-column:2;}.fCHAbb > :nth-child(2){grid-column:3;position:fixed;}}/*!sc*/
data-styled.g7[id="PageLayout__Container-sc-11jfopf-0"]{content:"fCHAbb,"}/*!sc*/
.cwRbEB{width:100%;padding:0 1rem;display:grid;}/*!sc*/
data-styled.g8[id="PageLayout__Main-sc-11jfopf-1"]{content:"cwRbEB,"}/*!sc*/
.fcNrhi{display:none;}/*!sc*/
@media (min-width:700px){.fcNrhi{display:block;padding:0 1rem;}}/*!sc*/
data-styled.g9[id="PageLayout__Side-sc-11jfopf-2"]{content:"fcNrhi,"}/*!sc*/
.hGxUVC{padding:0 1rem;overflow:auto;}/*!sc*/
data-styled.g10[id="Wiki__Main-sc-16q9onf-0"]{content:"hGxUVC,"}/*!sc*/
.dfdJvI{margin:0;padding:1rem 0 0 1rem;font-size:1rem;}/*!sc*/
data-styled.g11[id="Wiki__RelatedLinksHeader-sc-16q9onf-1"]{content:"dfdJvI,"}/*!sc*/
.rESXq{list-style:none;padding-left:1rem;margin:0;}/*!sc*/
.rESXq > li{padding:0;line-height:1;}/*!sc*/
data-styled.g12[id="Wiki__RelatedLinks-sc-16q9onf-2"]{content:"rESXq,"}/*!sc*/
.eafyKW{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1rem 0;gap:.5rem;}/*!sc*/
data-styled.g13[id="Wiki__TitleContainer-sc-16q9onf-3"]{content:"eafyKW,"}/*!sc*/
.bTkSse{margin:0;font-size:1.5rem;font-weight:700;color:#333333;}/*!sc*/
data-styled.g14[id="Wiki__Title-sc-16q9onf-4"]{content:"bTkSse,"}/*!sc*/
.djeJzE{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}/*!sc*/
data-styled.g15[id="Wiki__TitleBottom-sc-16q9onf-5"]{content:"djeJzE,"}/*!sc*/
.gTofNp{display:block;}/*!sc*/
@media (min-width:700px){.gTofNp{display:none;}}/*!sc*/
data-styled.g16[id="Wiki__TocMain-sc-16q9onf-6"]{content:"gTofNp,"}/*!sc*/
.dsJvyz{margin-top:2rem;max-width:20rem;}/*!sc*/
data-styled.g17[id="Wiki__TocSide-sc-16q9onf-7"]{content:"dsJvyz,"}/*!sc*/
</style><link rel="sitemap" type="application/xml" href="/cat-logic/sitemap-index.xml"/><link rel="icon" href="/cat-logic/favicon-32x32.png?v=8ac5e5872e5245b972f101c92acce617" type="image/png"/><link rel="manifest" href="/cat-logic/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/cat-logic/icons/icon-48x48.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="72x72" href="/cat-logic/icons/icon-72x72.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="96x96" href="/cat-logic/icons/icon-96x96.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="144x144" href="/cat-logic/icons/icon-144x144.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="192x192" href="/cat-logic/icons/icon-192x192.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="256x256" href="/cat-logic/icons/icon-256x256.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="384x384" href="/cat-logic/icons/icon-384x384.png?v=8ac5e5872e5245b972f101c92acce617"/><link rel="apple-touch-icon" sizes="512x512" href="/cat-logic/icons/icon-512x512.png?v=8ac5e5872e5245b972f101c92acce617"/><title data-gatsby-head="true">Cat Logic - Node JS</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="PageLayout__Container-sc-11jfopf-0 fCHAbb"><div class="PageLayout__Main-sc-11jfopf-1 cwRbEB"><div class="Wiki__Main-sc-16q9onf-0 hGxUVC"><div class="Wiki__TitleContainer-sc-16q9onf-3 eafyKW"><div class="HomeLink__Container-sc-1f7ngt2-0 kltskx"><a href="" class="Link__A-sc-k1di17-0 bUjFDA">CAT</a></div><a href="." class="Link__A-sc-k1di17-0 bUjFDA"><h1 class="Wiki__Title-sc-16q9onf-4 bTkSse">Node JS</h1></a></div><div class="Wiki__TitleBottom-sc-16q9onf-5 djeJzE"><div class="GitHubCommitLink__Container-sc-13f81rm-0 etrcVC"><a href="https://github.com/edunga1/cat-logic/commit/1f4bac13238b7dfc4354deebe1cb871976606b17">7/10/2024, 12:38:55 PM</a></div></div><div class="Toc__Container-sc-1f76i2s-0 cZcHEM Wiki__TocMain-sc-16q9onf-6 gTofNp"><ul>
<li>
<p><a href="#node-js">Node JS</a></p>
<ul>
<li>
<p><a href="#package-manager">Package Manager</a></p>
<ul>
<li><a href="#yarn">yarn</a></li>
<li><a href="#pnpm">pnpm</a></li>
</ul>
</li>
<li>
<p><a href="#test-runner">Test Runner</a></p>
</li>
<li>
<p><a href="#third-party-testing-libraries">Third-party testing libraries</a></p>
<ul>
<li>
<p><a href="#mocha---test-framework">Mocha - Test Framework</a></p>
</li>
<li>
<p><a href="#chai---assertion-library">Chai - Assertion Library</a></p>
</li>
<li>
<p><a href="#istanbul---test-coverage-tool">Istanbul - Test Coverage Tool</a></p>
</li>
<li>
<p><a href="#sinonjs---mocking-library">Sinon.JS - Mocking Library</a></p>
</li>
<li>
<p><a href="#proxyquire---stubbing-module-dependency-library">Proxyquire - Stubbing Module Dependency Library</a></p>
<ul>
<li>
<p><a href="#proxyquire-%EB%AA%A8%EB%93%88-%EB%A1%9C%EB%93%9C-%EC%88%9C%EC%84%9C-%EB%AC%B8%EC%A0%9C">proxyquire 모듈 로드 순서 문제</a></p>
</li>
<li>
<p><a href="#requireproxyquirenopreservecache-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0"><code class="language-text">require('proxyquire').noPreserveCache()</code> 사용하기</a></p>
</li>
<li>
<p><a href="#proxyquire-vs-rewire">Proxyquire vs. rewire</a></p>
<ul>
<li><a href="#%EC%B0%A8%EC%9D%B4%EC%A0%90">차이점</a></li>
<li><a href="#rewire-%EC%A0%9C%ED%95%9C%EC%82%AC%ED%95%AD">rewire 제한사항</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#nodejs-data-validation">NodeJS data validation</a></p>
</li>
<li>
<p><a href="#nodejs-%EC%84%9C%EB%B2%84-%EB%A1%9C%EC%BB%AC-%EC%9A%94%EC%B2%AD%EB%A7%8C-%ED%97%88%EC%9A%A9%ED%95%98%EA%B8%B0">NodeJS 서버 로컬 요청만 허용하기</a></p>
</li>
<li>
<p><a href="#pm2-deploy-%EC%8B%9C-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90">pm2 deploy 시 주의할 점</a></p>
</li>
<li>
<p><a href="#jupyter-notebook-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0">Jupyter notebook 사용하기</a></p>
</li>
<li>
<p><a href="#taming-architecture-complexity-in-v8">Taming architecture complexity in v8</a></p>
</li>
</ul>
</li>
</ul></div><div class="WikiContent__Container-sc-q3jb6a-0 hKcJdB">
<p>크로스플랫폼 자바스크립트 런타임. 보통 서버 사이드에서 사용한다.</p>
<p>node.js(2009)를 시작으로 Deno(2018), Bun(2023) 등 다양한 런타임이 나왔다.</p>
<p>웹 프론트엔드 개발과 서버 사이드를 같은 언어로 작성할 수 있다는 점은 초기 프로젝트 개발에 매력적인 요소이다.</p>
<h2 id="package-manager" style="position:relative;"><a href="#package-manager" aria-label="package manager permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Package Manager</h2>
<p>npm은 node.js의 패키지 관리자이다.
node.js 설치하면 npm을 함께 포함한다.</p>
<p>이 생태계에서 주로 사용하는 패키지매니저는 npm, yarn, pnpm이 있다.
3개 모두 <code class="language-text">package.json</code>을 사용한다. 추가로 패키지매니저 별로 lock와 별도 설정 파일을 사용한다.</p>
<p>어떤 node.js 프로젝트를 확인할 때 패키지매니저 전용 파일을 확인하거나,
<code class="language-text">package.json</code>의 <code class="language-text">packageManager</code> 필드를 확인하면 된다.
e.g. <a href="https://github.com/jestjs/jest/blob/main/package.json">jest</a>는 <code class="language-text">"packageManager": "yarn@3.6.4"</code></p>
<p><strong>의존성 설치 속도 비교</strong></p>
<p><a href="../cat-logic">cat logic</a> sites 프로젝트의 의존성 설치 속도를 비교했다.</p>
<table>
<thead>
<tr>
<th>Package Manager</th>
<th>Install Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>npm</td>
<td>20s</td>
</tr>
<tr>
<td>pnpm</td>
<td>2.9s</td>
</tr>
<tr>
<td>yarn v1</td>
<td>16.1s</td>
</tr>
</tbody>
</table>
<p>pnpm이 가장 빨랐다. 다만 모두 캐시된 상황이라 정확한 비교는 아니다.
github actions 환경에서 npm 40s, pnpm 19.3s 소요되었다.</p>
<h3 id="yarn" style="position:relative;"><a href="#yarn" aria-label="yarn permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>yarn</h3>
<p><a href="https://github.com/yarnpkg/yarn">yarn</a>은 v1과 그 이후 버전으로 프로젝트가 나뉜다.</p>
<p>yarn은 <code class="language-text">yarn.lock</code>을 lock 파일로 사용한다.</p>
<hr>
<p>2023-11 최근 yarn을 시도해 보았는데, 좋은 선택은 아닌 거 같다.
일단 <a href="https://github.com/yarnpkg/yarn">yarn</a> v1은 22년 이후로 1.22.19로 종료되었다.</p>
<p>이후로 yarn v2, v3, v4가 나왔는데, v1과 다른 프로젝다.
<a href="https://github.com/yarnpkg/berry">berry</a>라는 이름으로 yarn의 새 버전을 이끈다.
cli는 yarn 이름을 같이 사용하지만 프로젝트가 달라서 Homebrew로 설치도 할 수 없다.
예전에는 yarn이 npm보다 더 개선된 패키지 관리자라는 것이었는데,
이렇게 관리하는 것은 생태계에 혼란만 가져온다.</p>
<p>반면에 npm은 지금까지도 한 프로젝트에서 관리되고 있다.
그래서 혼란이 없다. node.js에 내장되어 있으므로 따로 설치할 필요도 없다.
다만 <code class="language-text">npm audit</code>은 짜증만 난다. 이걸로 제대로 고쳐지는 경우가 많이 없는 거 같다.</p>
<h3 id="pnpm" style="position:relative;"><a href="#pnpm" aria-label="pnpm permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pnpm</h3>
<p><a href="https://github.com/pnpm/pnpm">pnpm</a> GitHub Star가 가장 많다.
최근들어 흔하게 사용하는 거 같다.</p>
<p>설치는 <code class="language-text">npm install -g pnpm</code> 또는 <code class="language-text">brew install pnpm</code>.</p>
<ul>
<li><code class="language-text">pnpm-lock.yaml</code> lock 파일을 사용한다.</li>
<li><code class="language-text">pnpm-workspace.yaml</code> Monorepositories 위한 <a href="https://pnpm.io/workspaces">workspace</a> 설정 파일을 사용한다.</li>
</ul>
<p>Monorepo가 아니라면 <code class="language-text">pnpm-workspace.yaml</code>은 필요 없는 것으로 보인다.
괜히 빈 내용으로 추가하면 패키지 설치 시 매번 root project 경고가 발생한다.</p>
<p><code class="language-text">pnpm install</code> 시 warning이 줄어든 것을 확인할 수 있었다.
단순히 숨긴건지는 모르겠지만 <code class="language-text">npm install</code> 경우에는 수 많은 peer depdency warning으로 신경이 쓰이는 반면에 pnpm은 warning이 없었다.</p>
<hr>
<p>다른 패키지매니저와 <code class="language-text">node_modules</code> 구조가 다른지, migration 아티클들을 보면 <code class="language-text">node_modules</code>를 삭제하고 시작한다.</p>
<p><code class="language-text">node_modules</code> 구조는 <a href="https://pnpm.io/ko/blog/2020/05/27/flat-node-modules-is-not-the-only-way">평탄한 node_modules가 유일한 방법은 아닙니다.</a> 공식 블로그에서 설명한다.</p>
<p>expressjs를 설치했을 때 <code class="language-text">node_modules</code> 구조를 비교해보면 다음과 같다:</p>
<p>npm은</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">.bin
accepts
array-flatten
body-parser
bytes
content-disposition
cookie-signature
cookie
debug
depd
destroy
ee-first
encodeurl
escape-html
etag
express</code></pre></div>
<p>pnpm은</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">.pnpm
.modules.yaml
express</code></pre></div>
<p><code class="language-text">node_modules</code>를 평탄하게 유지하지 않는다. 또한 <code class="language-text">express</code> 폴더는 <strong>심볼릭 링크</strong>이다.</p>
<h2 id="test-runner" style="position:relative;"><a href="#test-runner" aria-label="test runner permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test Runner</h2>
<p>v20.0.0부터 node.js에서 테스트 러너를 자체적으로 제공한다.
v18.0.0, v16.17.0 부터 실험적 기능으로 추가되었다.</p>
<p><a href="https://nodejs.org/docs/latest/api/test.html">https://nodejs.org/docs/latest/api/test.html</a></p>
<p>사용 방법은 jest와 흡사하다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'top level test'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'subtest 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'subtest 2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code></pre></div>
<p>assert 라이브러리는 오래전부터 제공했었다.</p>
<p><code class="language-text">describe()</code> - <code class="language-text">it()</code> 스타일도 지원한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> describe<span class="token punctuation">,</span> it <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'A thing'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should be ok'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'a nested thing'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Mocking 라이브러리도 제공한다고 하니 이제는 별도 라이브러리를 설치할 필요 없이 가능할 거 같다.</p>
<hr>
<p>관련 문서</p>
<p><a href="https://snyk.io/blog/10-modern-node-js-runtime-features/">10 modern Node.js runtime features to start using in 2024</a></p>
<hr>
<p>gatsby 관련 플러그인을 jest에서 node.js 테스트 러너로 마이그레이션해 보았다.</p>
<p>작업 커밋: <a href="https://github.com/Edunga1/gatsby-transformer-gitinfo/commit/ccdc7f4ec61e487db047678d32c0f65d85cacd03">https://github.com/Edunga1/gatsby-transformer-gitinfo/commit/ccdc7f4ec61e487db047678d32c0f65d85cacd03</a></p>
<p>장점은 jest 의존성을 없앨 수 있었다는 점 하나 뿐인 듯.
다른 테스트 도구의 인터페이스와 비슷해서 크게 손이 많이 가지는 않았다.
다만 assertion 부분은 오래전부터 자체 제공했던 인터페이스를 유지하고 있어서, 모두 손봐야 했다.</p>
<p>또한 jest가 제공하는 편리한 검증 함수에 비하면 node.js의 검증 도구는 협소하다.
예를들어 두 Object가 다른 한 쪽의 부분 집합인지 확인하는 함수가 없어서, 항상 전체가 같은지 확인해야 한다.
부분 비교를 하고 싶으면 직접 구현하거나, <code class="language-text">lodash</code> 등 외부 라이브러리를 사용해야 하는데 테스트 때문에 추가해야 하는데 그러면 다른 테스트 도구를 사용하는 편이 낫겠다.</p>
<p>또한 jest의 <code class="language-text">expect.any(String)</code> 같은 matcher의 지원이 없어서 테스트 코드의 가독성이 떨어진다.</p>
<p>이런 Jest 코드가 있으면:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">expect</span><span class="token punctuation">(</span>createNodeField<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  node<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"gitLogLatestHash"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>아래와 같이 3개의 키를 가진 객체인지, 각 키의 값을 검증함으로써 같은 수준의 검증을 수행한다.
테스트 코드가 장황해진다. 검증이 많아진다면 더욱 그렇다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>createNodeField<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"gitLogLatestHash"</span><span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span></code></pre></div>
<p>또다른 이슈라면, 위 프로젝트는 esm을 사용하고 있어서 <code class="language-text">node</code> 명령어로 호출할 수 없다.
<code class="language-text">babel-node</code>를 통해서 실행해야 한다. <code class="language-text">node -r @babel/register --test **/*.spec.js</code>로 실행한다.
운영 코드를 <code class="language-text">.mjs</code>로 작성하거나 commonjs 모듈로 전환하면 babel-node를 사용하지 않아도 되겠지만.
babel을 사용하지 않는다면 <code class="language-text">node --test **/*.spec.js</code>로 실행한다.</p>
<h2 id="third-party-testing-libraries" style="position:relative;"><a href="#third-party-testing-libraries" aria-label="third party testing libraries permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Third-party testing libraries</h2>
<p>테스트 프레임워크인 mocha를 기반에 검증 라이브러리로 chai를 채택하는 라이브러리 조합 방식 대신,
<a href="https://github.com/facebook/jest">Jest</a>를 사용하면 모든 기능을 한 번에 제공받을 수 있다.
다른 테스트 라이브러리 의존을 추가할 필요가 없다는 장점이 있다.</p>
<p>아래 도구들은 Jest 이전에 주로 사용하던 도구들이다.</p>
<h3 id="mocha---test-framework" style="position:relative;"><a href="#mocha---test-framework" aria-label="mocha   test framework permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocha - Test Framework</h3>
<p>테스트 구조를 제공한다.</p>
<p>설치 : <code class="language-text">npm install mocha --save-dev</code></p>
<p>테스트 스크립트 실행 : <code class="language-text">mocha &lt;PATH></code></p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'어떤 테스트를 할 것인지 대략적인 설명'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 매 it() 마다 실행 할 코드</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'테스트 단위 별 설명'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 여기에 Assertion 코드를 둔다.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="chai---assertion-library" style="position:relative;"><a href="#chai---assertion-library" aria-label="chai   assertion library permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chai - Assertion Library</h3>
<p>Assertion 라이브러리. 값 비교에 사용한다.</p>
<p>설치 : <code class="language-text">npm install chai --save-dev</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'어떤 테스트를 할 것인지 대략적인 설명'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'테스트 단위 별 설명'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 여기에 Assertion 코드를 둔다.</span>
        <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 통과</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 값이 다르므로 통과하지 못함</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="istanbul---test-coverage-tool" style="position:relative;"><a href="#istanbul---test-coverage-tool" aria-label="istanbul   test coverage tool permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Istanbul - Test Coverage Tool</h3>
<p>코드 커버리지 도구. 내 <strong>테스트 코드</strong>가 <strong>모듈의 어디까지 테스트하는지 측정</strong>하는데 사용한다.</p>
<p><a href="https://github.com/istanbuljs/nyc">https://github.com/istanbuljs/nyc</a></p>
<p>기존 istanbul은 deprecated 되고, nyc로 새로운 프로젝트로 이전되었다. 아래 내용은 istanbul을 기준의 내용이다.</p>
<hr>
<p>설치: <code class="language-text">npm install istanbul --save-dev</code></p>
<p>테스트 시 <code class="language-text">coverage/</code> 폴더가 생성되어 리포트 페이지(html)를 생성한다. 페이지를 통해서 실제 모듈이 얼마나 호출 되었는지, 어디까지 테스트 되었는지 확인한다.</p>
<p>Mocha와 함께 실행: <code class="language-text">istanbul cover _mocha</code> (<code class="language-text">_mocha</code>인 이유는 Mocha의 프로세스 이름을 이용하기 때문)</p>
<h3 id="sinonjs---mocking-library" style="position:relative;"><a href="#sinonjs---mocking-library" aria-label="sinonjs   mocking library permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sinon.JS - Mocking Library</h3>
<p>자바스크립트를 위한 테스트 spies, stubs, mocks.
가짜 객체를 만들어서 기존 객체를 대체하여 테스트에 맞게 조작하는 도구이다.</p>
<p><code class="language-text">new Date()</code> 조작하기</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> clock <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1800-01-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wed Jan 01 1800 00:00:00 GMT+0900 (KST)</span>
clock<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now</span></code></pre></div>
<p><code class="language-text">useFakeTimers()</code>로부터 반환되는 객체의 <code class="language-text">restore()</code>를 호출하여 조작된 시간을 복구할 수 있다.</p>
<p>주의할 점은 복구하지 않고 다시 조작하는 경우.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> clock1 <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1800-01-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wed Jan 01 1800 00:00:00 GMT+0900 (KST)</span>
<span class="token keyword">var</span> clock2 <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2000-12-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Fri Dec 01 2000 00:00:00 GMT+0900 (KST)</span>
clock2<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wed Jan 01 1800 00:00:00 GMT+0900 (KST)</span>
clock1<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now</span></code></pre></div>
<p>나중에 조작한 시간을 복구해도 이전에 조작한 시간이 남아 있다.</p>
<p><code class="language-text">clock1</code>을 바로 복구해도 돌아올 수 있다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> clock1 <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1800-01-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wed Jan 01 1800 00:00:00 GMT+0900 (KST)</span>
<span class="token keyword">var</span> clock2 <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2000-12-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Fri Dec 01 2000 00:00:00 GMT+0900 (KST)</span>
clock1<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now</span></code></pre></div>
<h3 id="proxyquire---stubbing-module-dependency-library" style="position:relative;"><a href="#proxyquire---stubbing-module-dependency-library" aria-label="proxyquire   stubbing module dependency library permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proxyquire - Stubbing Module Dependency Library</h3>
<p>모듈 의존성을 원하는 객체로 대체하여 임포트하는 라이브러리.</p>
<p><a href="https://github.com/thlorenz/proxyquire">https://github.com/thlorenz/proxyquire</a></p>
<h4 id="proxyquire-모듈-로드-순서-문제" style="position:relative;"><a href="#proxyquire-%EB%AA%A8%EB%93%88-%EB%A1%9C%EB%93%9C-%EC%88%9C%EC%84%9C-%EB%AC%B8%EC%A0%9C" aria-label="proxyquire 모듈 로드 순서 문제 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>proxyquire 모듈 로드 순서 문제</h4>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">src/
    router/
        auth.js
    find-basic-member.js
    app.js
test/
    test.js</code></pre></div>
<p><code class="language-text">app.js</code> -> <code class="language-text">auth.js</code> -> <code class="language-text">find-basic-member.js</code> 이와같은 모듈 의존 관계가 있다.</p>
<p>테스트 대상은 <code class="language-text">app.js</code>.
Mocking 대상은 <code class="language-text">auth.js</code>가 사용하는 <code class="language-text">find-basic-member.js</code></p>
<p>사용 방법:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">proxyquire</span><span class="token punctuation">(</span><span class="token string">'../src/router/auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'../find-basic-member'</span><span class="token operator">:</span> mockFindBasicMember
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// app uses mock find-basic-member</span></code></pre></div>
<p>위 코드가 Mocking 이 되는 이유는
<code class="language-text">app.js</code> -> <code class="language-text">auth.js</code>의 <code class="language-text">require('../find-basic-member')</code>를 호출하더라도
<code class="language-text">proxyrequire</code>에 의해 캐시된 모듈을 이용하기 때문이다.</p>
<p>nodejs <code class="language-text">require</code> 또한 캐시된 정보를 사용하기 때문에 여러번 <code class="language-text">require</code> 해도 실제 파일을 읽는건 한 번 뿐이다.</p>
<p><em>Forcing proxyquire to reload modules</em> 단락 참고: <a href="https://github.com/thlorenz/proxyquire">https://github.com/thlorenz/proxyquire</a></p>
<p>다음과 같이 호출 순서를 변경하면 동작하지 않는다:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// app uses original find-basic-member</span>
<span class="token function">proxyquire</span><span class="token punctuation">(</span><span class="token string">'../src/router/auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'../find-basic-member'</span><span class="token operator">:</span> mockFindBasicMember
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">proxyquire</code>가 <code class="language-text">app.js</code> -> <code class="language-text">auth.js</code>의 <code class="language-text">require('../find-basic-member')</code>를 사용한다.</p>
<h4 id="requireproxyquirenopreservecache-사용하기" style="position:relative;"><a href="#requireproxyquirenopreservecache-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" aria-label="requireproxyquirenopreservecache 사용하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">require('proxyquire').noPreserveCache()</code> 사용하기</h4>
<p>위의 예제처럼 사용한 경우 <code class="language-text">proxyquire()</code> 이후에 로드하는 모듈은 모두 Mock Module을 사용한다.</p>
<p>따라서 명확하게 Mock Module 의존을 주입할 필요가 있다.</p>
<p><code class="language-text">noPreserveCache()</code>는 캐시된 모듈을 사용하지 않고 다시 모듈을 로드한다.</p>
<p><code class="language-text">proxyquire()</code>의 반환은 Mock Module 이다. 이를 이용해 의존성을 직접 주입한다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> mockAuth <span class="token operator">=</span> <span class="token function">proxyquire</span><span class="token punctuation">(</span><span class="token string">'../src/router/auth'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'../find-basic-member'</span><span class="token operator">:</span> mockFindBasicMember
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockApp <span class="token operator">=</span> <span class="token function">proxyquire</span><span class="token punctuation">(</span><span class="token string">'../src/app'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'./router/auth'</span><span class="token operator">:</span> mockAuth
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>의존의 의존을 모두 명시한다.</p>
<h4 id="proxyquire-vs-rewire" style="position:relative;"><a href="#proxyquire-vs-rewire" aria-label="proxyquire vs rewire permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proxyquire vs. rewire</h4>
<p>테스트 할 때 Dependency Injection 하는데 사용하는 도구 2가지 비교.</p>
<p>rewire: <a href="https://github.com/jhnns/rewire">https://github.com/jhnns/rewire</a></p>
<p>rewire는 <em>monkey-patching</em> 도구라고 설명하고 있다.</p>
<p>proxyquire: <a href="https://github.com/thlorenz/proxyquire">https://github.com/thlorenz/proxyquire</a></p>
<p>proxyquire는 의존 모듈을 덮어 쓴다고 설명하고 있다. <em>overriding dependencies</em></p>
<h5 id="차이점" style="position:relative;"><a href="#%EC%B0%A8%EC%9D%B4%EC%A0%90" aria-label="차이점 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>차이점</h5>
<p>rewire: 테스트 대상 내에 선언한 변수를 가로채어 바꾼다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// app.js</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// test.js</span>
<span class="token keyword">const</span> rewire <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rewire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">rewire</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 테스트 대상</span>

app<span class="token punctuation">.</span><span class="token function">__set__</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span></code></pre></div>
<p>proxyquire: 테스트 대상이 <code class="language-text">require</code>하는 모듈을 바꿔서 보내준다.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// bar.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// app.js</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// test.js</span>
<span class="token keyword">const</span> proxyquire <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'proxyquire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 테스트 대상 및 의존 모듈 mocking</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">proxyquire</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'./bar'</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span></code></pre></div>
<h5 id="rewire-제한사항" style="position:relative;"><a href="#rewire-%EC%A0%9C%ED%95%9C%EC%82%AC%ED%95%AD" aria-label="rewire 제한사항 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rewire 제한사항</h5>
<p>rewire는 <code class="language-text">const</code>로 선언된 변수는 변경할 수 없었다. 따라서 의존 모듈을 <code class="language-text">const</code>에 할당하면 stub 할 수 없다.
이 문제 때문에 일단 proxyquire를 사용하고 있다.</p>
<h2 id="nodejs-data-validation" style="position:relative;"><a href="#nodejs-data-validation" aria-label="nodejs data validation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NodeJS data validation</h2>
<p>웹 서버를 작성할 때, 요청 데이터를 수동으로 검증하는 일은 너무 피곤하다.</p>
<p>Python Django는 자체적으로 Form 클래스를 제공한다:<br>
<a href="https://developer.mozilla.org/ko/docs/Learn/Server-side/Django/Forms">https://developer.mozilla.org/ko/docs/Learn/Server-side/Django/Forms</a></p>
<p>Django Form은 정말 다양한 필드를 지원한다.</p>
<p>Python Flask는 WTForm 또는 Marshmallow을 사용한다:</p>
<ul>
<li><a href="https://github.com/wtforms/wtforms">https://github.com/wtforms/wtforms</a></li>
<li><a href="https://github.com/marshmallow-code/marshmallow">https://github.com/marshmallow-code/marshmallow</a></li>
</ul>
<p>WTForm이 경량하게 사용할 수 있었고, Marshmallow는 사용해보지 않았다.
Marshmallow는 Django의 Form과 영속성을 결합한 Model Form과 비슷한 기능을 지원하는 거 같다.</p>
<p>NodeJS는 아직까지 사용해본 적이 없다.
이때까지 수동으로 처리해왔는데 너무 힘들었다.
이런거도 해보려다가 말았다:<br>
<a href="https://github.com/Edunga1/grooming-type-checker">https://github.com/Edunga1/grooming-type-checker</a></p>
<p>expressjs나 다른 프레임워크는 어떻게 처리하는지 찾아보니 Joi를 사용하는가 보다.
Joi는 hapijs의 생태계에서 개발되었다.</p>
<p>hapijs에 종속되지 않아서 어느 곳에서나 사용할 수 있다:</p>
<blockquote>
<p>The most powerful schema description language and data validator for JavaScript.</p>
</blockquote>
<h2 id="nodejs-서버-로컬-요청만-허용하기" style="position:relative;"><a href="#nodejs-%EC%84%9C%EB%B2%84-%EB%A1%9C%EC%BB%AC-%EC%9A%94%EC%B2%AD%EB%A7%8C-%ED%97%88%EC%9A%A9%ED%95%98%EA%B8%B0" aria-label="nodejs 서버 로컬 요청만 허용하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NodeJS 서버 로컬 요청만 허용하기</h2>
<p><a href="https://stackoverflow.com/questions/14043926/node-js-connect-only-works-on-localhost">https://stackoverflow.com/questions/14043926/node-js-connect-only-works-on-localhost</a><br>
여기에서 힌트를 얻었음</p>
<p><a href="https://nodejs.org/api/net.html#net_server_listen_port_host_backlog_callback">https://nodejs.org/api/net.html#net_server_listen_port_host_backlog_callback</a><br>
<code class="language-text">server.listen()</code> 스펙을 보면 포트 번호와 함께 host(ip)를 입력하면 해당 ip만 허용한다.</p>
<p>기본값은 <code class="language-text">0.0.0.0</code>이고 '지정되지 않음'을 의미하며 외부 ip의 연결도 허용하지만, <code class="language-text">127.0.0.1</code>으로 두면 로컬 연결만 허용된다.</p>
<p>근데, 이렇게 로컬 요청을 구분하는 것은 좋지 않은 것으로 보인다.
MSA 환경 구축하면 다른 머신의 연결도 있을테니까.
virtual host 또는 방화벽으로 막는게 합리적으로 보인다.</p>
<h2 id="pm2-deploy-시-주의할-점" style="position:relative;"><a href="#pm2-deploy-%EC%8B%9C-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90" aria-label="pm2 deploy 시 주의할 점 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pm2 deploy 시 주의할 점</h2>
<p>pm2는 node.js 운영 환경의 프로세스 매니저이다.
원격 서버에 코드를 배포하고, 애플리케이션을 다중 실행, 모니터링 등 다양한 기능을 제공한다.</p>
<p>Docker가 일반적으로 사용되기 전에는 pm2가 좋은 선택이었다.</p>
<hr>
<p><a href="http://pm2.keymetrics.io/docs/usage/deployment/#complete-tutorial">pm2 deploy tutorial</a>
처럼 <code class="language-text">post-deploy</code>를 다음과 같이 저장하는 경우 조심해야 한다.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"post-deploy"</span><span class="token operator">:</span> <span class="token string">"npm install &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span></code></pre></div>
<p><code class="language-text">pm2 deploy</code> 하면 다음 절차로 일이 발생한다:</p>
<ol>
<li>로컬 <code class="language-text">ecosystem.json</code>과 같은 설정 파일을 읽어들임</li>
<li>명세한 서버 정보(<code class="language-text">user</code>, <code class="language-text">host</code>)로 리모트 서버에 접속</li>
<li>(리모트 서버에서) git pull</li>
<li>(리모트 서버에서) npm install</li>
<li>(리모트 서버에서) pm2 startOrRestart ecosystem.json --env production</li>
<li>(리모트 서버에서) 위 명령어에 의한 <code class="language-text">ecosystem.json</code> 설정 파일을 읽어들임</li>
<li><code class="language-text">apps</code> 명세에 따른 배포</li>
</ol>
<p>그러니까 설정 파일은 로컬에서, 리모트에서 총 2번 읽어들인다.</p>
<p>그래서 pm2는 현재 브랜치가 트래킹 중인 리모트 브랜치와 달라지면 싱크를 맞추라고 한다: <code class="language-text">push your changes before deploying</code></p>
<p>로컬과 서버의 설정 파일이 불일치하면 골치 아파진다. 서로 다른 설정 파일을 읽기 때문에 원하는 대로 작업이 이루어지지 않을 수도 있다.
원인은 로컬에서 실행되는 명령어의 명세인 <code class="language-text">deploy</code>, 리모트 서버에서 실행되는 명령어의 명세인 <code class="language-text">apps</code>를 보통 하나의 파일에서 관리하고
코드베이스에 포함하기 때문인데, 설정 파일을 다른 위치에 두면 로컬과 리모트의 설정 파일의 싱크를 보장할 수 없다.</p>
<hr>
<p>pm2로 배포 프로세스를 관리하고 싶어서 설정 파일을 작성하였으나, 데이터베이스 비밀번호를 <code class="language-text">env</code>에 저장하면 코드베이스에 포함되기 때문에,
다른 repository로 분리하려 했다.</p>
<p>그래서 <code class="language-text">npm run deploy</code>하면 셸 스크립트를 실행하도록 했다:</p>
<ol>
<li>pm2 설정 파일을 가지는 저장소<code class="language-text">git clone git@github.com:user/repo.git .config</code></li>
<li><code class="language-text">pm2 deploy .config/ecosystem.json production</code></li>
</ol>
<p>리모트 서버에는 <code class="language-text">config</code> 저장소를 하나 클론 받아놓고 적절한 곳에 두고
<code class="language-text">post-deploy</code>를 <code class="language-text">"npm install &amp;&amp; pm2 startOrRestart /home/node/config/ecosystem.json --env production"</code>
설정 파일의 위치를 해당 위치를 가리키도록 했다.</p>
<p>이러다보니 설정 정보를 업데이트해도 리모트에서 다시 pull 하지 않으면 로컬에서는 최신 설정을, 리모트에서는 이전 설정을 사용하는 문제가 있다.</p>
<p>따라서 리모트에서도 항상 <code class="language-text">config</code> 저장소를 clone 후 <code class="language-text">pm2 startOrRestart</code> 하도록 해야겠다.</p>
<h2 id="jupyter-notebook-사용하기" style="position:relative;"><a href="#jupyter-notebook-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" aria-label="jupyter notebook 사용하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Jupyter notebook 사용하기</h2>
<p>[Jupyter Docker Stacks](docker#Jupyter Docker Stacks)</p>
<h2 id="taming-architecture-complexity-in-v8" style="position:relative;"><a href="#taming-architecture-complexity-in-v8" aria-label="taming architecture complexity in v8 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Taming architecture complexity in v8</h2>
<p><a href="https://blog.theori.io/taming-architecture-complexity-in-v8-translation-47564093473b">https://blog.theori.io/taming-architecture-complexity-in-v8-translation-47564093473b</a></p>
<p><a href="https://v8.dev/blog/csa">원문</a>을 번역한 글.</p>
<p>옛날엔 내장 함수(builtin)가 self-hosted, JS로 작성되기도 했다.
그러다보니 성능 이슈가 있었고, 어셈블리로 다시 작성되었다.</p>
<p>성능은 향상되었으나, 유지보수를 하는데 어려워졌다.</p>
<p>그래서 어셈블리어로 변환해주는 중간 계층을 두었다.
프레임워크처럼 C++ 매크로로 틀에 맞춰 작성하면,
어셈블리 코드로 변환된다.</p>
<p>테스트코드 또한 C++로 작성할 수 있다.</p>
<p>문자열 객체에 길이를 구하는 <code class="language-text">GetStringLength</code> 함수를 작성하는
자세한 예시를 보여주니 좋다.</p>
<p>작성한 C++ 코드의 가독성이 좋아 보인다:</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token function">TF_BUILTIN</span><span class="token punctuation">(</span>GetStringLength<span class="token punctuation">,</span> CodeStubAssembler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Label <span class="token function">not_string</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Node<span class="token operator">*</span> <span class="token keyword">const</span> maybe_string <span class="token operator">=</span> <span class="token function">Parameter</span><span class="token punctuation">(</span>Descriptor<span class="token double-colon punctuation">::</span>kInputObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">GotoIf</span><span class="token punctuation">(</span><span class="token function">TaggedIsSmi</span><span class="token punctuation">(</span>maybe_string<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>not_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">GotoIfNot</span><span class="token punctuation">(</span><span class="token function">IsString</span><span class="token punctuation">(</span>maybe_string<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>not_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Return</span><span class="token punctuation">(</span><span class="token function">LoadStringLength</span><span class="token punctuation">(</span>maybe_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">BIND</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>not_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Return</span><span class="token punctuation">(</span><span class="token function">UndefinedConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a href="https://blog.hassler.ec/wp/2019/04/07/1-powerful-way-to-write-robust-code/">견고한 코드를 작성하는 방법</a>
글이 생각났다. 진입점은 깔끔하게 유지하기.</p></div><div class="Comments__Container-sc-1ajj4d9-0 gcJKrk"><hr/><div></div></div></div></div><div class="PageLayout__Side-sc-11jfopf-2 fcNrhi"><div><h3 class="Wiki__RelatedLinksHeader-sc-16q9onf-1 dfdJvI">Related Links</h3><ul class="Wiki__RelatedLinks-sc-16q9onf-2 rESXq"><li><a href="../javascript" style="font-size:0.5em;margin-right:0.5em">javascript</a></li><li><a href="../shell" style="font-size:0.5em;margin-right:0.5em">shell</a></li><li><a href="../rust" style="font-size:0.5em;margin-right:0.5em">rust</a></li><li><a href="../testing" style="font-size:0.5em;margin-right:0.5em">testing</a></li><li><a href="../web" style="font-size:0.5em;margin-right:0.5em">web</a></li></ul></div><div class="Toc__Container-sc-1f76i2s-0 cZcHEM Wiki__TocSide-sc-16q9onf-7 dsJvyz"><ul>
<li>
<p><a href="#node-js">Node JS</a></p>
<ul>
<li>
<p><a href="#package-manager">Package Manager</a></p>
<ul>
<li><a href="#yarn">yarn</a></li>
<li><a href="#pnpm">pnpm</a></li>
</ul>
</li>
<li>
<p><a href="#test-runner">Test Runner</a></p>
</li>
<li>
<p><a href="#third-party-testing-libraries">Third-party testing libraries</a></p>
<ul>
<li>
<p><a href="#mocha---test-framework">Mocha - Test Framework</a></p>
</li>
<li>
<p><a href="#chai---assertion-library">Chai - Assertion Library</a></p>
</li>
<li>
<p><a href="#istanbul---test-coverage-tool">Istanbul - Test Coverage Tool</a></p>
</li>
<li>
<p><a href="#sinonjs---mocking-library">Sinon.JS - Mocking Library</a></p>
</li>
<li>
<p><a href="#proxyquire---stubbing-module-dependency-library">Proxyquire - Stubbing Module Dependency Library</a></p>
<ul>
<li>
<p><a href="#proxyquire-%EB%AA%A8%EB%93%88-%EB%A1%9C%EB%93%9C-%EC%88%9C%EC%84%9C-%EB%AC%B8%EC%A0%9C">proxyquire 모듈 로드 순서 문제</a></p>
</li>
<li>
<p><a href="#requireproxyquirenopreservecache-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0"><code class="language-text">require('proxyquire').noPreserveCache()</code> 사용하기</a></p>
</li>
<li>
<p><a href="#proxyquire-vs-rewire">Proxyquire vs. rewire</a></p>
<ul>
<li><a href="#%EC%B0%A8%EC%9D%B4%EC%A0%90">차이점</a></li>
<li><a href="#rewire-%EC%A0%9C%ED%95%9C%EC%82%AC%ED%95%AD">rewire 제한사항</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#nodejs-data-validation">NodeJS data validation</a></p>
</li>
<li>
<p><a href="#nodejs-%EC%84%9C%EB%B2%84-%EB%A1%9C%EC%BB%AC-%EC%9A%94%EC%B2%AD%EB%A7%8C-%ED%97%88%EC%9A%A9%ED%95%98%EA%B8%B0">NodeJS 서버 로컬 요청만 허용하기</a></p>
</li>
<li>
<p><a href="#pm2-deploy-%EC%8B%9C-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90">pm2 deploy 시 주의할 점</a></p>
</li>
<li>
<p><a href="#jupyter-notebook-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0">Jupyter notebook 사용하기</a></p>
</li>
<li>
<p><a href="#taming-architecture-complexity-in-v8">Taming architecture complexity in v8</a></p>
</li>
</ul>
</li>
</ul></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/wiki/nodejs/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-b032883371e35e8a6711.js\"],\"component---src-components-gatsby-templates-wiki-tsx\":[\"/component---src-components-gatsby-templates-wiki-tsx-2d3331c2d7f81ca2a7ef.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-2de46ab5bde6a80cb40d.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="d01208ec2546d8fe27dd";</script><script src="/cat-logic/webpack-runtime-b39f44bb1078f1006773.js" async></script><script src="/cat-logic/framework-3d24f1df4806fe1cdcfc.js" async></script><script src="/cat-logic/app-b032883371e35e8a6711.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>