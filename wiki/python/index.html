<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.6.0"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><style data-styled="" data-styled-version="5.3.6">.hbDcaS{box-sizing:border-box;padding:4rem 2rem 0 0;background-color:#f5f5f5;}/*!sc*/
.hbDcaS ul{list-style:none;padding-left:1rem;font-size:.8rem;font-weight:bold;}/*!sc*/
.hbDcaS ul ul{font-size:.6rem;font-weight:normal;}/*!sc*/
.hbDcaS ul p{margin:0;}/*!sc*/
.hbDcaS a{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g1[id="Toc__Container-sc-1f76i2s-0"]{content:"hbDcaS,"}/*!sc*/
.iPgyli{padding-left:1rem;}/*!sc*/
.iPgyli a{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g2[id="WikiContent__Container-sc-q3jb6a-0"]{content:"iPgyli,"}/*!sc*/
.gVurN{display:grid;grid-template-columns:minmax(300px,1fr) minmax(400px,1000px);width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;}/*!sc*/
@media (max-width:1000px){.gVurN{grid-template-columns:1fr;}.gVurN > div:nth-child(1){display:none;}}/*!sc*/
data-styled.g3[id="markdownRemarkfields__slug__Container-sc-cg714z-0"]{content:"gVurN,"}/*!sc*/
</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="markdownRemarkfields__slug__Container-sc-cg714z-0 gVurN"><div><div class="Toc__Container-sc-1f76i2s-0 hbDcaS"><ul>
<li>
<p><a href="#python">Python</a></p>
</li>
<li>
<p><a href="#%EA%B0%9C%EB%B0%9C%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">개발환경 구성</a></p>
</li>
<li>
<p><a href="#%EA%B0%9C%EB%B0%9C%EB%8F%84%EA%B5%AC">개발도구</a></p>
<ul>
<li>
<p><a href="#pyright">pyright</a></p>
<ul>
<li><a href="#pyright-%EC%84%A4%EC%B9%98">pyright 설치</a></li>
</ul>
</li>
<li>
<p><a href="#pylint">pylint</a></p>
</li>
<li>
<p><a href="#mypy">mypy</a></p>
<ul>
<li><a href="#django-stubs">Django Stubs</a></li>
</ul>
</li>
<li>
<p><a href="#ruff">Ruff</a></p>
</li>
<li>
<p><a href="#python-code-formatter-autopep8-vs-black-vs-yapf">python code formatter: autopep8 vs black vs yapf</a></p>
</li>
<li>
<p><a href="#%EB%A0%88%EA%B1%B0%EC%8B%9C%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%84%A4%EC%A0%95">레거시를 위한 설정</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#python-mock">Python mock</a></p>
<ul>
<li><a href="#decorator%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-mocking">Decorator를 사용한 mocking.</a></li>
<li><a href="#patchrequestsget"><code>@patch('requests.get')</code></a></li>
<li><a href="#patchobjectmymodule-requests"><code>@patch.object(mymodule, 'requests')</code></a></li>
<li><a href="#patchobjectmymodule-requests-newmyrequests"><code>@patch.object(mymodule, 'requests', new=MyRequests)</code></a></li>
<li><a href="#patchobjectmymodule-method-return_valuenone"><code>@patch.object(mymodule, 'method', return_value=None)</code></a></li>
</ul>
</li>
<li>
<p><a href="#package-manager">Package manager</a></p>
<ul>
<li><a href="#pipenv">pipenv</a></li>
</ul>
</li>
<li>
<p><a href="#packaging">Packaging</a></p>
<ul>
<li><a href="#__all__"><code>__all__</code></a></li>
</ul>
</li>
</ul></div><a href="../language-server-protocol" style="font-size:0.5em;margin-right:0.5em">language-server-protocol</a></div><div class="WikiContent__Container-sc-q3jb6a-0 iPgyli"><h1 id="python" style="position:relative;"><a href="#python" aria-label="python permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python</h1>
<h1 id="개발환경-구성" style="position:relative;"><a href="#%EA%B0%9C%EB%B0%9C%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1" aria-label="개발환경 구성 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>개발환경 구성</h1>
<p>pyenv, pyenv-virtualenv로 파이썬 가상환경을 관리하자.</p>
<pre><code class="language-bash">brew install pyenv
brew install pyenv-virtualenv
</code></pre>
<h1 id="개발도구" style="position:relative;"><a href="#%EA%B0%9C%EB%B0%9C%EB%8F%84%EA%B5%AC" aria-label="개발도구 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>개발도구</h1>
<p>vim 기본 설정으로는 텍스트에디터 역할밖에 못한다.</p>
<p>최소한 pyright는 사용하자.</p>
<p>왠만해선 pyright + pylint + mypy는 권장한다. python 2 프로젝트라도 도움을 받을 수 있다.
에러가 너무 많다면 설정을 타협하자. 아래 레거시를 위한 설정에서 다룬다.</p>
<p>nvim-lspconfig, null-ls 이용하여 다음과 같이 설정, 사용하고 있다.</p>
<pre><code class="language-lua">-- vim 설정 파일의 일부분
server = require 'lspconfig'.pyright,
sources = {
    null_ls.builtins.diagnostics.pylint,
    null_ls.builtins.diagnostics.mypy.with {
        extra_args = { '--ignore-missing-imports' }
    },
    null_ls.builtins.formatting.autopep8,
    null_ls.builtins.formatting.isort,
},
</code></pre>
<h2 id="pyright" style="position:relative;"><a href="#pyright" aria-label="pyright permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pyright</h2>
<p><a href="https://github.com/microsoft/pyright">https://github.com/microsoft/pyright</a></p>
<p><a href="/cat-logic/7056617538c1aded5f999a2ad07c36e5/language-server-protocol.md">language server</a> for python.</p>
<p>django 프로젝트라면 <a href="https://github.com/sbdchd/django-types">django-types</a>를 설치하자.
mypy와 django-stubs처럼 django model의 필드 타입을 제공한다.</p>
<pre><code class="language-python">class User(models.Model):
    name = models.CharField(max_length=100)
    age = models.IntegerField()

user = User.objects.get(id=1)
user.age = 10  # should error
</code></pre>
<p><code>age</code> 필드는 <code>IntegerField</code>로 추정하기 때문에 <code>user.age = 10</code>에서 타입 문제가 있다고 알려준다.
django-types는 이런 문제를 해결해준다.</p>
<p>django-types는 django-stubs의 fork project이다.</p>
<blockquote>
<p>non-mypy type checkers like pyright will work better with Django.</p>
</blockquote>
<h3 id="pyright-설치" style="position:relative;"><a href="#pyright-%EC%84%A4%EC%B9%98" aria-label="pyright 설치 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pyright 설치</h3>
<ul>
<li>nvim-lspconfig은 <code>Mason</code>을 사용하자: <code>:MasonInstall pyright</code></li>
<li><a href="https://github.com/fannheyward/coc-pyright">coc-nvim</a>: <code>:CocInstall coc-pyright</code></li>
</ul>
<h2 id="pylint" style="position:relative;"><a href="#pylint" aria-label="pylint permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pylint</h2>
<p><a href="https://github.com/PyCQA/pylint">https://github.com/PyCQA/pylint</a>
정적 분석 도구.</p>
<h2 id="mypy" style="position:relative;"><a href="#mypy" aria-label="mypy permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mypy</h2>
<p><a href="https://github.com/python/mypy">https://github.com/python/mypy</a></p>
<blockquote>
<p>Optional static typing for Python</p>
</blockquote>
<p>정적 타입 검사 도구.</p>
<p>타입 명세를 할 수 없는 경우에는 <code>Need type annotation for "variable"</code> 에러 메시지를 막기 위해 <code>my.ini</code> 생성하고 다음과 같이 설정하자:</p>
<pre><code>[mypy]

# disable error 'Need type annotation for "variable"'
disallow_untyped_defs = False
</code></pre>
<h3 id="django-stubs" style="position:relative;"><a href="#django-stubs" aria-label="django stubs permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Django Stubs</h3>
<p><a href="https://github.com/typeddjango/django-stubs">https://github.com/typeddjango/django-stubs</a></p>
<p>django는 <code>objects</code> 등 마법을 사용해서 타입 제공을 제대로 받을 수 없다.</p>
<p>djang-stubs는 django 매직과 관련된 타입 정보를 제공한다.</p>
<h2 id="ruff" style="position:relative;"><a href="#ruff" aria-label="ruff permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ruff</h2>
<p><a href="https://github.com/charliermarsh/ruff">https://github.com/charliermarsh/ruff</a></p>
<p>rust로 작성된 python linter.</p>
<p>Pylint와 비교하여 매우 빠르다. README에 벤치마크가 있는데 Pylint로 > 60s 걸리는 코드베이스가 0.29s 걸린다고 한다.</p>
<p>실제로 Pylint로 1분 6초 걸리는 프로젝트에서 명령어 입력 즉시 결과가 나왔다.</p>
<p>단점은 아직 Pylint보다 많은 기능을 제공하지 않는다.
예를들어 Pylint는 <a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/broad-exception-caught.html">broad-exception-caught</a>와 <a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/convention/consider-using-f-string.html">consider-using-f-string</a>을 잡아주지만 Ruff는 그렇지 않다.</p>
<p>아직 많이 사용해보지 않아서 그 차이가 어느정도인지는 잘 모르겠다.
기능은 부족하지만 매우 빠른 장점으로 앞으로 자주 사용할 것 같다.</p>
<p>nvim은 <a href="https://github.com/jose-elias-alvarez/null-ls.nvim/blob/main/doc/BUILTINS.md#ruff">null-ls</a>에서 제공한다. diagnostic, formatter 두 개 소스로 제공한다.
Pylint와 함께 사용해보면 Ruff의 반응이 빨라서 항상 Pylint보다 Ruff의 진단이 먼저 노출된다.</p>
<p><strong>개발 환경 구성 시 주의해야 한다.</strong></p>
<p>Ruff 설명대로 rust로 작성되어 있어서 로컬 개발 환경이나, 개발용 Docker 환경 구성을 위해서 Rust 런타임 환경을 구성이 필요할 수 있다.
macOS 기준으로는 별도 도구 없이 설치되었지만, python alpine 이미지 기준으로 설치에 실패한다.</p>
<p>flake8, isort 등에서 <a href="https://beta.ruff.rs/docs/rules/">lint rules</a>을 가져왔다. 500+개의 규칙이 있다.</p>
<p>isort와 마찬가지로 사용되지 않는 import는 제거한단다. isort가 필요 없을지도.</p>
<p><a href="https://github.com/apache/airflow/blob/main/pyproject.toml#L29">Apache Airflow</a>,
<a href="https://github.com/tiangolo/fastapi/blob/master/pyproject.toml#L164">FastAPI</a>,
<a href="https://github.com/huggingface/transformers/blob/main/pyproject.toml#L5">Hugging Face</a>,
<a href="https://github.com/pandas-dev/pandas/blob/main/pyproject.toml#L194.md">Pandas</a>
<a href="https://github.com/scipy/scipy/blob/main/pyproject.toml#L121.md">SciPy</a>
등 대규모 프로젝트에서 ruff를 사용하고 있다. pylint와 함께 사용하는 곳도 아닌곳도 있다.</p>
<blockquote>
<p>Ruff can be used to replace Flake8 (plus dozens of plugins), isort, pydocstyle, yesqa, eradicate, pyupgrade, and autoflake, all while executing tens or hundreds of times faster than any individual tool.</p>
</blockquote>
<p>Flake8, isort 등 도구를 대체할 수 있다고 한다.</p>
<h2 id="python-code-formatter-autopep8-vs-black-vs-yapf" style="position:relative;"><a href="#python-code-formatter-autopep8-vs-black-vs-yapf" aria-label="python code formatter autopep8 vs black vs yapf permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>python code formatter: autopep8 vs black vs yapf</h2>
<p>파이썬 코드 formatter 3종 비교.</p>
<p><a href="https://github.com/neoclide/coc.nvim">coc.nvim</a>에서는 파이썬 파일을 열 때 3개 중 하나를 선택하도록 한다:</p>
<pre><code class="language-sh">Formatter autopep8 is not installed. Install?:
1. Yes
2. Use black
3. Use yapf
</code></pre>
<p><a href="https://www.reddit.com/r/Python/comments/8oqy03/blog_a_comparison_of_autopep8_black_and_yapf_code/.md">Blog: A comparison of autopep8, black, and yapf - Code formatters for Python</a><br>
3개를 비교한 다른 글. 덧글에는 black을 사용하고 만족했다나.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>stars</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/hhatto/autopep8">autopep8</a></td>
<td>4.3k</td>
<td>pep8 스타일 사용. 가장 많은 커밋</td>
</tr>
<tr>
<td><a href="https://github.com/psf/black">black</a></td>
<td>31.2k</td>
<td>가장 많은 star</td>
</tr>
<tr>
<td><a href="https://github.com/google/yapf">yapf</a></td>
<td>13k</td>
<td>구글이 maintainer</td>
</tr>
</tbody>
</table>
<p><strong>실제 사용 비교</strong></p>
<p>비교 대상 코드</p>
<pre><code class="language-python">{
  "refundDeposit": self.refund_deposit and _deposit_to_dict(self.refund_deposit)
}
</code></pre>
<p><strong>black</strong></p>
<pre><code class="language-python">{
  "refundDeposit": self.refund_deposit
  and _deposit_to_dict(self.refund_deposit)
}
</code></pre>
<p>이게 맞나?</p>
<p><strong>yapf</strong></p>
<pre><code class="language-python">{
  "refundDeposit":
  self.refund_deposit and _deposit_to_dict(self.refund_deposit)
}
</code></pre>
<p>이게 맞나?2</p>
<p><strong>autopep8</strong>
코드를 변경하지 않는다.</p>
<p>개인적으로는 black, yapf의 스타일이 별로라서 autopep8을 사용하고 있다.</p>
<h2 id="레거시를-위한-설정" style="position:relative;"><a href="#%EB%A0%88%EA%B1%B0%EC%8B%9C%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%84%A4%EC%A0%95" aria-label="레거시를 위한 설정 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>레거시를 위한 설정</h2>
<p>pyright, mypy를 타입 명세하지 않는 등 레거시 프로젝트에서 사용하면 무수히 많은 에러 메시지가 출력된다.
disable 하는 편이 차라리 낫다.</p>
<p>파이썬 도구는 <code>pyrightconfig.json</code>, <code>mypy.ini</code> 등 설정 파일을 사용하거나, 공통 설정 파일인 <code>pyproject.toml</code>을 사용한다.</p>
<p>아래는 <code>pyproject.toml</code>에 설정한 내용이다:</p>
<pre><code class="language-toml">[tool.mypy]
python_version = "3.8"
plugins = ["mypy_django_plugin.main"]
disallow_untyped_defs = false


[tool.django-stubs]
django_settings_module = "app.settings"


[tool.pyright]
reportGeneralTypeIssues = true


[tool.pylint.master]
load-plugins = [
  "pylint_django",
]
django-settings-module = "app.settings"
[tool.pylint.messages_control]
disable = [
  "missing-docstring",
  "too-few-public-methods",
  "too-many-instance-attributes",
  "trailing-newlines",
  "too-many-arguments",
  "too-many-public-methods",
  "invalid-name",
  "too-many-locals",
  "too-many-return-statements",
  "too-many-lines",
]
[tool.pylint.format]
max-line-length = 150
</code></pre>
<p>mypy, pyright, pylint 설정을 모두 <code>pyproject.toml</code>에 넣었다.</p>
<p><code>reportGeneralTypeIssues = false</code>는 <code>Cannot access member "id" for type "UserFactory"   Member "id" is unknown</code> 같은 에러를 무시한다.
django, factory-boy 등 파이썬 매직을 사용하는 경우 이런 문제가 발생하는데 무시하자. 최신 버전부터는 이런 문제가 없는지 확인하지 않았다.<br>
타입을 잘 명세하는 경우, <code>Literal['foo', 'bar']</code> 와 같이 명세하고 에러를 정적 체크하는 것은 매우 유용한데, 이런 에러도 무시하게 된다.
<code>cannot access member ~</code>만 무시하고 <code>Argument of type "Literal['foo', 'bar']" cannot be assigned to parameter "param_name" of type</code> 같은 에러는 리포트 받고 싶은데, 아직 방법을 찾지 못했다.<br>
일단 <code>true</code>로 설정하여 번거롭지만 <code>Cannot access member ~</code> 에러도 리포트 받도록 했다.</p>
<p><code>disallow_untyped_defs</code>는 mypy에서 타입 명세하지 않으면 에러 메시지를 출력하는 옵션이다. 이것도 무시한다.</p>
<p>pyproject.toml은 최근에서야 대부분 도구가 지원하는 것 같다.
도구 버전이 낮으면 toml 양식을 인식하지 못하는 경우가 있어서 최신 버전인지 확인해야 한다.
도구마다 설정 파일을 각각 관리하기 어려워서 pyproject.toml 하나로 여러 프로젝트에서 사용하고 있다.</p>
<h1 id="python-mock" style="position:relative;"><a href="#python-mock" aria-label="python mock permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python mock</h1>
<p><a href="https://docs.python.org/3/library/unittest.mock.html">https://docs.python.org/3/library/unittest.mock.html</a></p>
<p>설치: <code>pip install mock</code></p>
<h2 id="decorator를-사용한-mocking" style="position:relative;"><a href="#decorator%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-mocking" aria-label="decorator를 사용한 mocking permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Decorator를 사용한 mocking.</h2>
<pre><code class="language-python">from mock import patch
import mymodule


class Mytest(unittest.TestCase):
  @patch.object(mymodule, 'method')
  def test_normal(self):
    pass
</code></pre>
<p>테스트는 주로 클래스로 하나의 테스트 슈트를 구성하고,
Mocking은 각 테스트(method)에 <code>@patch.object</code>나 <code>@patch</code> decorator를 주로 사용하고 있다.</p>
<p><code>requests</code> 모듈을 mocking 한다고 가정하자.</p>
<h2 id="patchrequestsget" style="position:relative;"><a href="#patchrequestsget" aria-label="patchrequestsget permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>@patch('requests.get')</code></h2>
<p>어디서든 <code>requests.get()</code> 사용한다면, mock 객체를 반환한다.
간단한 방법이지만, <code>mymodule</code>에서 <code>requests</code>를 사용함을 암시적으로 보여준다.</p>
<h2 id="patchobjectmymodule-requests" style="position:relative;"><a href="#patchobjectmymodule-requests" aria-label="patchobjectmymodule requests permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>@patch.object(mymodule, 'requests')</code></h2>
<p><code>mymodule</code> 내에서만 <code>requests</code>를 사용한다는 점을 명시적으로 표현한다.
개인적으로 이 방법을 더 많이 사용한다.</p>
<p><code>requests</code> 자체가 mock 객체이기 때문에, <code>requests</code>의 <code>get</code>, <code>post</code> 등 모든 함수들이
mock 객체가 된다.</p>
<p><code>get</code> 응답을 대체하고 싶으면, 테스트 안에서, 넘어오는 mock 객체를 변경해야 한다:</p>
<pre><code class="language-python">class Mytest(unittest.TestCase):
  @patch.object(mymodule, 'requests')
  def test_normal(self, mock_requests):
    mock_requests.get.return_value = None
</code></pre>
<p>테스트 내에서만 mocking 정보를 명시하기 때문에, 다른 테스트에서 재사용할 수 없다.</p>
<h2 id="patchobjectmymodule-requests-newmyrequests" style="position:relative;"><a href="#patchobjectmymodule-requests-newmyrequests" aria-label="patchobjectmymodule requests newmyrequests permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>@patch.object(mymodule, 'requests', new=MyRequests)</code></h2>
<p><code>requests</code>가 <code>MyRequests</code>로 대체된다.</p>
<pre><code class="language-python">class MyRequests(object):
  @staticmethod
  def get(*args, **kwargs):
    res = Mock()
    res.headers = {
      'content-type': 'text/html'
    }
    return res
</code></pre>
<p>위와 같은 방법으로 <code>get</code> 함수만 내가 원하는 응답을 내려주게 하고,
<code>post</code> 등 다른 함수는 기본 mock 객체를 내려준다.</p>
<p>mocking 정보를 다른 테스트에서도 재사용할 수 있어서 유용하다.</p>
<h2 id="patchobjectmymodule-method-return_valuenone" style="position:relative;"><a href="#patchobjectmymodule-method-return_valuenone" aria-label="patchobjectmymodule method return_valuenone permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>@patch.object(mymodule, 'method', return_value=None)</code></h2>
<p><code>mymodule.method()</code> 반환값을 <code>None</code>으로 대체한다.</p>
<h1 id="package-manager" style="position:relative;"><a href="#package-manager" aria-label="package manager permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Package manager</h1>
<p>파이썬의 패키지 매니저인 pip는 파이썬 설치 시 함께 제공된다.
그러나 다른 언어의 패키지 매니저와 비교해 보면 안좋다.</p>
<p><code>pip install PACKAGE_NAME</code>로 설치하고 <code>pip freeze > requirements.txt</code>로
의존 모듈 목록을 저장하는데, 의존성의 의존성까지 저장하게 된다.
Django만 설치했는데, Django가 사용하는 다른 패키지도 포함된다.</p>
<p>개발과 프로덕션 환경 관리도 애매하다. <code>pip freeze > requirements-dev.txt</code> 처럼
수동으로 관리해야 하는데, 프로덕션만 업데이트 하려고 해도 이미 개발 환경의 모듈이
포함되어 있다.</p>
<p>아무튼, 간단하지만 그만큼 이런저런 불편함이 있는 기본 도구다.</p>
<h2 id="pipenv" style="position:relative;"><a href="#pipenv" aria-label="pipenv permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipenv</h2>
<p><a href="https://github.com/pypa/pipenv">https://github.com/pypa/pipenv</a></p>
<p>이런 불편함을 알았는지 환경 분리도 가능하고, lock 파일도 별도로 관리할 수 있는
<a href="https://github.com/pypa/pipenv">pipenv</a>가 있다. <code>pyenv</code>와 좀 헷갈린다.</p>
<p><a href="https://www.python.org/">python.org</a>에서도 가상 <code>pipenv</code>를 이용하여 가상환경 사용을 추천하고 있다:</p>
<blockquote>
<p>For software that is not distributed with (or developed for) your system, we recommend using a virtual environment, possibly with an environment manager like conda or pipenv, to help avoid disrupting your system Python installation.</p>
</blockquote>
<p>link: <a href="https://packaging.python.org/guides/tool-recommendations/">https://packaging.python.org/guides/tool-recommendations/</a></p>
<p>설치가 좀 애매한데, OSX는 Homebrew로 쉽게 설치가능해 보인다.</p>
<p>ubuntu 14.04에서는 다른 선택지가 없어서 <code>pip install</code>로 설치해봤는데 <code>2018.11.26</code> 버전이 설치됐다.
구버전 같아 보이는데 아직 제대로 사용해보지 않아서, 최적화된 버전 일지도 모르겠다.</p>
<p>Dockerize 하는데 이슈가 있다. 빌드 할 때 pipenv를 결국 설치해야 하는데, 로직을 돌리는데 불필요한 존재기 때문이다.
그래서 multi-stage build를 하는 것이 필요하다. 빌드 스테이지에서 pipenv를 설치하고, pipenv를 이용하여 requirements.txt를 생성하고,
requirements.txt를 가지고 실행 스테이지에서 의존 모듈을 설치한다. 그러면 프로덕션 레벨에서 pipenv를 감출 수 있다.</p>
<h1 id="packaging" style="position:relative;"><a href="#packaging" aria-label="packaging permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Packaging</h1>
<h2 id="__all__" style="position:relative;"><a href="#__all__" aria-label="__all__ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>__all__</code></h2>
<p><code>my_module.py</code>라는 파일이 있다고 하자:</p>
<pre><code class="language-python">__all__ = ['foo', 'Bar']


def foo():
  pass


class Bar:
  pass


_baz = 1
</code></pre>
<p>파일 최상단에 <code>__all__</code>을 사용한다고 <code>my_module.py</code>을 임포트 했을 때 <code>_baz</code>에 접근하지 못하게 할 수는 없다.</p>
<p><code>from my_module import _baz</code></p>
<p>하지만 <code>__all__</code>을 사용하면 <code>__init__.py</code>를 사용했을 때 효과가 있다.</p>
<pre><code>my_module/
  __init__.py
  my_module.py
</code></pre>
<p>위 구조로 만들어 두고 <code>__init__.py</code>에서 <code>my_module.py</code>를 asterisk를 이용하여 임포트한다:</p>
<pre><code class="language-python">from my_module.my_module import *  # NOQA
</code></pre>
<p>flake8이 경고를 출력하므로 <code># NOQA</code>로 무시하도록 했다.</p>
<p>이렇게하면 <code>my_module</code>을 사용하는 곳에선 <code>foo</code>, <code>bar</code>만 가져올 수 있다.</p>
<pre><code class="language-python">from my_module import foo, bar  # 가능
from my_module import _baz  # 불가능
</code></pre></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/wiki/python/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-23acf9067c23d58b9db4.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-7bfef5ca48decc695459.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-a6d255ad0e2dec90f2a0.js\"],\"component---src-pages-wiki-markdown-remark-fields-slug-tsx\":[\"/component---src-pages-wiki-markdown-remark-fields-slug-tsx-40ec24b803c8c46a430e.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="51d9389186c93ceebac3";</script><script src="/cat-logic/webpack-runtime-b4e88552983183ae7411.js" async></script><script src="/cat-logic/framework-9b6d338de49a676a1843.js" async></script><script src="/cat-logic/app-23acf9067c23d58b9db4.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>